"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ERROR_MSG = void 0;
exports.flattenDeps = flattenDeps;
exports.injector = injector;
exports.provideRecipesToInjector = provideRecipesToInjector;
exports.typeCheckRecipe = typeCheckRecipe;
exports.withState = withState;
var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));
var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));
var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _react = _interopRequireDefault(require("react"));
var _reactRedux = require("react-redux");
var _redux = require("redux");
var _window = require("global/window");
var _context = _interopRequireDefault(require("./context"));
var _excluded = ["state"]; // SPDX-License-Identifier: MIT
// Copyright contributors to the kepler.gl project
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { (0, _defineProperty2["default"])(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
var MissingComp = function MissingComp() {
  return /*#__PURE__*/_react["default"].createElement("div", null);
};
var ERROR_MSG = exports.ERROR_MSG = {
  wrongRecipeType: "injectComponents takes an array of factories replacement pairs as input, " + "each pair be a array as [originalFactory, replacement].",
  noDep: function noDep(fac, parent) {
    return "".concat(fac.name, " is required as a dependency of ").concat(parent.name, ", ") + "but is not provided to injectComponents. It will not be rendered.";
  },
  notFunc: 'factory and its replacement should be a function'
};
function injector() {
  var map = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : new Map();
  var cache = new Map(); // map<factory, factory -> ?>
  var _get = function get(fac, parent) {
    var factory = map.get(fac);
    // factory is not injected
    if (!factory) {
      _window.console.error(ERROR_MSG.noDep(fac, parent));
      return MissingComp;
    }

    // check if custom factory deps is declared
    var instances = cache.get(factory) || factory.apply(void 0, (0, _toConsumableArray2["default"])(factory.deps ? factory.deps.map(function (dep) {
      return _get(dep, factory);
    }) : []));
    cache.set(fac, instances);
    return instances;
  };

  // if you have two functions that happen to have the exactly same text
  // it will be override: 2018-02-05
  return {
    provide: function provide(factory, replacement) {
      if (!typeCheckRecipe([factory, replacement])) {
        return injector(map);
      }
      return injector(new Map(map).set(factory, replacement));
    },
    get: _get
  };
}

// entryPoint
function flattenDeps(allDeps, factory) {
  var addToDeps = allDeps.includes(factory) ? allDeps : allDeps.concat([factory]);
  return Array.isArray(factory.deps) && factory.deps.length ? factory.deps.reduce(function (accu, dep) {
    return flattenDeps(accu, dep);
  }, addToDeps) : addToDeps;
}
function provideRecipesToInjector(recipes, appInjector) {
  var provided = new Map();
  var injector = recipes.reduce(function (inj, recipe) {
    var _inj;
    if (!typeCheckRecipe(recipe)) {
      return inj;
    }

    // collect dependencies of custom factories, if there is any.
    // Add them to the appInjector
    var customDependencies = flattenDeps([], recipe[1]);
    inj = customDependencies.reduce(function (ij, factory) {
      if (provided.get(factory)) {
        _window.console.warn("".concat(factory.name, " already injected from ").concat(provided.get(factory).name, ", injecting ").concat(recipe[0].name, " after ").concat(provided.get(factory).name, " will override it"));
      }
      return ij.provide(factory, factory);
    }, inj);
    provided.set(recipe[0], recipe[1]);
    return (_inj = inj).provide.apply(_inj, (0, _toConsumableArray2["default"])(recipe));
  }, appInjector);

  // make sure all component instance are cached
  provided.forEach(function (v) {
    injector.get(v);
  });
  return injector;
}
function typeCheckRecipe(recipe) {
  if (!Array.isArray(recipe) || recipe.length < 2) {
    _window.console.error('Error injecting [factory, replacement]', recipe);
    _window.console.error(ERROR_MSG.wrongRecipeType);
    return false;
  }
  var _recipe = (0, _slicedToArray2["default"])(recipe, 2),
    factory = _recipe[0],
    replacement = _recipe[1];
  if (typeof factory !== 'function') {
    _window.console.error('Error injecting factory: ', factory);
    _window.console.error(ERROR_MSG.notFunc);
    return false;
  } else if (typeof replacement !== 'function') {
    _window.console.error('Error injecting replacement for: ', factory);
    _window.console.error(ERROR_MSG.notFunc);
    return false;
  }
  return true;
}
var identity = function identity(state) {
  return state;
};
// Helper to add reducer state to custom component
function withState() {
  var lenses = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var mapStateToProps = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : identity;
  var actions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
  return function (Component) {
    var WrappedComponent = function WrappedComponent(_ref) {
      var state = _ref.state,
        props = (0, _objectWithoutProperties2["default"])(_ref, _excluded);
      return /*#__PURE__*/_react["default"].createElement(_context["default"].Consumer, null, function (context) {
        return /*#__PURE__*/_react["default"].createElement(Component, lenses.reduce(function (totalState, lens) {
          return _objectSpread(_objectSpread({}, totalState), lens(context.selector(state)));
        }, props));
      });
    };
    return (0, _reactRedux.connect)(function (state) {
      return _objectSpread(_objectSpread({}, mapStateToProps(state)), {}, {
        state: state
      });
    }, function (dispatch) {
      return Object.keys(actions).reduce(function (accu, key) {
        return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2["default"])({}, key, (0, _redux.bindActionCreators)(actions[key], dispatch)));
      }, {});
    })(WrappedComponent);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcmVhY3QiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9yZWFjdFJlZHV4IiwiX3JlZHV4IiwiX3dpbmRvdyIsIl9jb250ZXh0IiwiX2V4Y2x1ZGVkIiwib3duS2V5cyIsImUiLCJyIiwidCIsIk9iamVjdCIsImtleXMiLCJnZXRPd25Qcm9wZXJ0eVN5bWJvbHMiLCJvIiwiZmlsdGVyIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZW51bWVyYWJsZSIsInB1c2giLCJhcHBseSIsIl9vYmplY3RTcHJlYWQiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJmb3JFYWNoIiwiX2RlZmluZVByb3BlcnR5MiIsImdldE93blByb3BlcnR5RGVzY3JpcHRvcnMiLCJkZWZpbmVQcm9wZXJ0aWVzIiwiZGVmaW5lUHJvcGVydHkiLCJNaXNzaW5nQ29tcCIsImNyZWF0ZUVsZW1lbnQiLCJFUlJPUl9NU0ciLCJleHBvcnRzIiwid3JvbmdSZWNpcGVUeXBlIiwibm9EZXAiLCJmYWMiLCJwYXJlbnQiLCJjb25jYXQiLCJuYW1lIiwibm90RnVuYyIsImluamVjdG9yIiwibWFwIiwidW5kZWZpbmVkIiwiTWFwIiwiY2FjaGUiLCJnZXQiLCJmYWN0b3J5IiwiQ29uc29sZSIsImVycm9yIiwiaW5zdGFuY2VzIiwiX3RvQ29uc3VtYWJsZUFycmF5MiIsImRlcHMiLCJkZXAiLCJzZXQiLCJwcm92aWRlIiwicmVwbGFjZW1lbnQiLCJ0eXBlQ2hlY2tSZWNpcGUiLCJmbGF0dGVuRGVwcyIsImFsbERlcHMiLCJhZGRUb0RlcHMiLCJpbmNsdWRlcyIsIkFycmF5IiwiaXNBcnJheSIsInJlZHVjZSIsImFjY3UiLCJwcm92aWRlUmVjaXBlc1RvSW5qZWN0b3IiLCJyZWNpcGVzIiwiYXBwSW5qZWN0b3IiLCJwcm92aWRlZCIsImluaiIsInJlY2lwZSIsIl9pbmoiLCJjdXN0b21EZXBlbmRlbmNpZXMiLCJpaiIsIndhcm4iLCJ2IiwiX3JlY2lwZSIsIl9zbGljZWRUb0FycmF5MiIsImlkZW50aXR5Iiwic3RhdGUiLCJ3aXRoU3RhdGUiLCJsZW5zZXMiLCJtYXBTdGF0ZVRvUHJvcHMiLCJhY3Rpb25zIiwiQ29tcG9uZW50IiwiV3JhcHBlZENvbXBvbmVudCIsIl9yZWYiLCJwcm9wcyIsIl9vYmplY3RXaXRob3V0UHJvcGVydGllczIiLCJDb25zdW1lciIsImNvbnRleHQiLCJ0b3RhbFN0YXRlIiwibGVucyIsInNlbGVjdG9yIiwiY29ubmVjdCIsImRpc3BhdGNoIiwia2V5IiwiYmluZEFjdGlvbkNyZWF0b3JzIl0sInNvdXJjZXMiOlsiLi4vc3JjL2luamVjdG9yLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtjb25uZWN0fSBmcm9tICdyZWFjdC1yZWR1eCc7XG5pbXBvcnQge2JpbmRBY3Rpb25DcmVhdG9yc30gZnJvbSAncmVkdXgnO1xuaW1wb3J0IHtcbiAgTWFwU3RhdGVUb1Byb3BzUGFyYW0sXG4gIE1hcERpc3BhdGNoVG9Qcm9wc1BhcmFtLFxuICBJbmZlcmFibGVDb21wb25lbnRFbmhhbmNlcldpdGhQcm9wc1xufSBmcm9tICdyZWFjdC1yZWR1eCc7XG5pbXBvcnQge2NvbnNvbGUgYXMgQ29uc29sZX0gZnJvbSAnZ2xvYmFsL3dpbmRvdyc7XG5pbXBvcnQgS2VwbGVyR2xDb250ZXh0IGZyb20gJy4vY29udGV4dCc7XG5cbmV4cG9ydCB0eXBlIEZhY3RvcnlFbGVtZW50ID0gKC4uLmFyZ3MpID0+IFJlYWN0LkNvbXBvbmVudFR5cGU7XG5leHBvcnQgdHlwZSBGYWN0b3J5ID0gRmFjdG9yeUVsZW1lbnQgJiB7XG4gIGRlcHM6IEZhY3RvcnlFbGVtZW50W107XG59O1xuXG5leHBvcnQgdHlwZSBJbmplY3RvclR5cGUgPSB7XG4gIHByb3ZpZGU6IChmYWN0b3J5OiBhbnksIHJlcGxhY2VtZW50OiBhbnkpID0+IEluamVjdG9yVHlwZTtcbiAgZ2V0OiAoZmFjOiBhbnksIHBhcmVudD86IGFueSkgPT4gYW55O1xufTtcblxuY29uc3QgTWlzc2luZ0NvbXAgPSAoKSA9PiA8ZGl2IC8+O1xuXG5leHBvcnQgY29uc3QgRVJST1JfTVNHID0ge1xuICB3cm9uZ1JlY2lwZVR5cGU6XG4gICAgYGluamVjdENvbXBvbmVudHMgdGFrZXMgYW4gYXJyYXkgb2YgZmFjdG9yaWVzIHJlcGxhY2VtZW50IHBhaXJzIGFzIGlucHV0LCBgICtcbiAgICBgZWFjaCBwYWlyIGJlIGEgYXJyYXkgYXMgW29yaWdpbmFsRmFjdG9yeSwgcmVwbGFjZW1lbnRdLmAsXG5cbiAgbm9EZXA6IChmYWMsIHBhcmVudCkgPT5cbiAgICBgJHtmYWMubmFtZX0gaXMgcmVxdWlyZWQgYXMgYSBkZXBlbmRlbmN5IG9mICR7cGFyZW50Lm5hbWV9LCBgICtcbiAgICBgYnV0IGlzIG5vdCBwcm92aWRlZCB0byBpbmplY3RDb21wb25lbnRzLiBJdCB3aWxsIG5vdCBiZSByZW5kZXJlZC5gLFxuXG4gIG5vdEZ1bmM6ICdmYWN0b3J5IGFuZCBpdHMgcmVwbGFjZW1lbnQgc2hvdWxkIGJlIGEgZnVuY3Rpb24nXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gaW5qZWN0b3IobWFwID0gbmV3IE1hcCgpKTogSW5qZWN0b3JUeXBlIHtcbiAgY29uc3QgY2FjaGUgPSBuZXcgTWFwKCk7IC8vIG1hcDxmYWN0b3J5LCBmYWN0b3J5IC0+ID8+XG4gIGNvbnN0IGdldCA9IChmYWMsIHBhcmVudCkgPT4ge1xuICAgIGNvbnN0IGZhY3RvcnkgPSBtYXAuZ2V0KGZhYyk7XG4gICAgLy8gZmFjdG9yeSBpcyBub3QgaW5qZWN0ZWRcbiAgICBpZiAoIWZhY3RvcnkpIHtcbiAgICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLm5vRGVwKGZhYywgcGFyZW50KSk7XG4gICAgICByZXR1cm4gTWlzc2luZ0NvbXA7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgaWYgY3VzdG9tIGZhY3RvcnkgZGVwcyBpcyBkZWNsYXJlZFxuICAgIGNvbnN0IGluc3RhbmNlcyA9XG4gICAgICBjYWNoZS5nZXQoZmFjdG9yeSkgfHxcbiAgICAgIGZhY3RvcnkoLi4uKGZhY3RvcnkuZGVwcyA/IGZhY3RvcnkuZGVwcy5tYXAoZGVwID0+IGdldChkZXAsIGZhY3RvcnkpKSA6IFtdKSk7XG5cbiAgICBjYWNoZS5zZXQoZmFjLCBpbnN0YW5jZXMpO1xuICAgIHJldHVybiBpbnN0YW5jZXM7XG4gIH07XG5cbiAgLy8gaWYgeW91IGhhdmUgdHdvIGZ1bmN0aW9ucyB0aGF0IGhhcHBlbiB0byBoYXZlIHRoZSBleGFjdGx5IHNhbWUgdGV4dFxuICAvLyBpdCB3aWxsIGJlIG92ZXJyaWRlOiAyMDE4LTAyLTA1XG4gIHJldHVybiB7XG4gICAgcHJvdmlkZTogKGZhY3RvcnksIHJlcGxhY2VtZW50KSA9PiB7XG4gICAgICBpZiAoIXR5cGVDaGVja1JlY2lwZShbZmFjdG9yeSwgcmVwbGFjZW1lbnRdKSkge1xuICAgICAgICByZXR1cm4gaW5qZWN0b3IobWFwKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBpbmplY3RvcihuZXcgTWFwKG1hcCkuc2V0KGZhY3RvcnksIHJlcGxhY2VtZW50KSk7XG4gICAgfSxcbiAgICBnZXRcbiAgfTtcbn1cblxuLy8gZW50cnlQb2ludFxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5EZXBzKGFsbERlcHM6IEZhY3RvcnlbXSwgZmFjdG9yeTogYW55KTogRmFjdG9yeVtdIHtcbiAgY29uc3QgYWRkVG9EZXBzID0gYWxsRGVwcy5pbmNsdWRlcyhmYWN0b3J5KSA/IGFsbERlcHMgOiBhbGxEZXBzLmNvbmNhdChbZmFjdG9yeV0pO1xuICByZXR1cm4gQXJyYXkuaXNBcnJheShmYWN0b3J5LmRlcHMpICYmIGZhY3RvcnkuZGVwcy5sZW5ndGhcbiAgICA/IGZhY3RvcnkuZGVwcy5yZWR1Y2UoKGFjY3UsIGRlcCkgPT4gZmxhdHRlbkRlcHMoYWNjdSwgZGVwKSwgYWRkVG9EZXBzKVxuICAgIDogYWRkVG9EZXBzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZVJlY2lwZXNUb0luamVjdG9yKHJlY2lwZXM6IFtGYWN0b3J5LCBGYWN0b3J5XVtdLCBhcHBJbmplY3RvcjogSW5qZWN0b3JUeXBlKSB7XG4gIGNvbnN0IHByb3ZpZGVkID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0IGluamVjdG9yID0gcmVjaXBlcy5yZWR1Y2UoKGluaiwgcmVjaXBlKSA9PiB7XG4gICAgaWYgKCF0eXBlQ2hlY2tSZWNpcGUocmVjaXBlKSkge1xuICAgICAgcmV0dXJuIGluajtcbiAgICB9XG5cbiAgICAvLyBjb2xsZWN0IGRlcGVuZGVuY2llcyBvZiBjdXN0b20gZmFjdG9yaWVzLCBpZiB0aGVyZSBpcyBhbnkuXG4gICAgLy8gQWRkIHRoZW0gdG8gdGhlIGFwcEluamVjdG9yXG4gICAgY29uc3QgY3VzdG9tRGVwZW5kZW5jaWVzID0gZmxhdHRlbkRlcHMoW10sIHJlY2lwZVsxXSk7XG4gICAgaW5qID0gY3VzdG9tRGVwZW5kZW5jaWVzLnJlZHVjZSgoaWosIGZhY3RvcnkpID0+IHtcbiAgICAgIGlmIChwcm92aWRlZC5nZXQoZmFjdG9yeSkpIHtcbiAgICAgICAgQ29uc29sZS53YXJuKFxuICAgICAgICAgIGAke2ZhY3RvcnkubmFtZX0gYWxyZWFkeSBpbmplY3RlZCBmcm9tICR7cHJvdmlkZWQuZ2V0KGZhY3RvcnkpLm5hbWV9LCBpbmplY3RpbmcgJHtcbiAgICAgICAgICAgIHJlY2lwZVswXS5uYW1lXG4gICAgICAgICAgfSBhZnRlciAke3Byb3ZpZGVkLmdldChmYWN0b3J5KS5uYW1lfSB3aWxsIG92ZXJyaWRlIGl0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGlqLnByb3ZpZGUoZmFjdG9yeSwgZmFjdG9yeSk7XG4gICAgfSwgaW5qKTtcblxuICAgIHByb3ZpZGVkLnNldChyZWNpcGVbMF0sIHJlY2lwZVsxXSk7XG4gICAgcmV0dXJuIGluai5wcm92aWRlKC4uLnJlY2lwZSk7XG4gIH0sIGFwcEluamVjdG9yKTtcblxuICAvLyBtYWtlIHN1cmUgYWxsIGNvbXBvbmVudCBpbnN0YW5jZSBhcmUgY2FjaGVkXG4gIHByb3ZpZGVkLmZvckVhY2godiA9PiB7XG4gICAgaW5qZWN0b3IuZ2V0KHYpO1xuICB9KTtcblxuICByZXR1cm4gaW5qZWN0b3I7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0eXBlQ2hlY2tSZWNpcGUocmVjaXBlKSB7XG4gIGlmICghQXJyYXkuaXNBcnJheShyZWNpcGUpIHx8IHJlY2lwZS5sZW5ndGggPCAyKSB7XG4gICAgQ29uc29sZS5lcnJvcignRXJyb3IgaW5qZWN0aW5nIFtmYWN0b3J5LCByZXBsYWNlbWVudF0nLCByZWNpcGUpO1xuICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLndyb25nUmVjaXBlVHlwZSk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgW2ZhY3RvcnksIHJlcGxhY2VtZW50XSA9IHJlY2lwZTtcbiAgaWYgKHR5cGVvZiBmYWN0b3J5ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgQ29uc29sZS5lcnJvcignRXJyb3IgaW5qZWN0aW5nIGZhY3Rvcnk6ICcsIGZhY3RvcnkpO1xuICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLm5vdEZ1bmMpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgcmVwbGFjZW1lbnQgIT09ICdmdW5jdGlvbicpIHtcbiAgICBDb25zb2xlLmVycm9yKCdFcnJvciBpbmplY3RpbmcgcmVwbGFjZW1lbnQgZm9yOiAnLCBmYWN0b3J5KTtcbiAgICBDb25zb2xlLmVycm9yKEVSUk9SX01TRy5ub3RGdW5jKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXaXRoU3RhdGU8Um9vdFN0YXRlPiB7XG4gIDxUU3RhdGVQcm9wcyA9IG9iamVjdCwgVERpc3BhdGNoUHJvcHMgPSBvYmplY3QsIFRPd25Qcm9wcyA9IG9iamVjdCwgU3RhdGUgPSBSb290U3RhdGU+KFxuICAgIGxlbnNlczogYW55W10sXG4gICAgbWFwU3RhdGVUb1Byb3BzOiBNYXBTdGF0ZVRvUHJvcHNQYXJhbTxUU3RhdGVQcm9wcywgVE93blByb3BzLCBTdGF0ZT4sXG4gICAgbWFwRGlzcGF0Y2hUb1Byb3BzPzogTWFwRGlzcGF0Y2hUb1Byb3BzUGFyYW08VERpc3BhdGNoUHJvcHMsIFRPd25Qcm9wcz5cbiAgKTogSW5mZXJhYmxlQ29tcG9uZW50RW5oYW5jZXJXaXRoUHJvcHM8VFN0YXRlUHJvcHMgJiBURGlzcGF0Y2hQcm9wcywgVE93blByb3BzPjtcbn1cblxuY29uc3QgaWRlbnRpdHkgPSBzdGF0ZSA9PiBzdGF0ZTtcbi8vIEhlbHBlciB0byBhZGQgcmVkdWNlciBzdGF0ZSB0byBjdXN0b20gY29tcG9uZW50XG5leHBvcnQgZnVuY3Rpb24gd2l0aFN0YXRlKGxlbnNlczogYW55W10gPSBbXSwgbWFwU3RhdGVUb1Byb3BzID0gaWRlbnRpdHksIGFjdGlvbnMgPSB7fSkge1xuICByZXR1cm4gQ29tcG9uZW50ID0+IHtcbiAgICBjb25zdCBXcmFwcGVkQ29tcG9uZW50ID0gKHtzdGF0ZSwgLi4ucHJvcHN9KSA9PiAoXG4gICAgICA8S2VwbGVyR2xDb250ZXh0LkNvbnN1bWVyPlxuICAgICAgICB7Y29udGV4dCA9PiAoXG4gICAgICAgICAgPENvbXBvbmVudFxuICAgICAgICAgICAgey4uLmxlbnNlcy5yZWR1Y2UoXG4gICAgICAgICAgICAgICh0b3RhbFN0YXRlLCBsZW5zKSA9PiAoe1xuICAgICAgICAgICAgICAgIC4uLnRvdGFsU3RhdGUsXG4gICAgICAgICAgICAgICAgLi4ubGVucyhjb250ZXh0LnNlbGVjdG9yKHN0YXRlKSlcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIHByb3BzXG4gICAgICAgICAgICApfVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L0tlcGxlckdsQ29udGV4dC5Db25zdW1lcj5cbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbm5lY3QoXG4gICAgICBzdGF0ZSA9PiAoey4uLm1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSksIHN0YXRlfSksXG4gICAgICBkaXNwYXRjaCA9PlxuICAgICAgICBPYmplY3Qua2V5cyhhY3Rpb25zKS5yZWR1Y2UoXG4gICAgICAgICAgKGFjY3UsIGtleSkgPT4gKHtcbiAgICAgICAgICAgIC4uLmFjY3UsXG4gICAgICAgICAgICBba2V5XTogYmluZEFjdGlvbkNyZWF0b3JzKGFjdGlvbnNba2V5XSwgZGlzcGF0Y2gpXG4gICAgICAgICAgfSksXG4gICAgICAgICAge31cbiAgICAgICAgKVxuICAgICkoV3JhcHBlZENvbXBvbmVudCk7XG4gIH07XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQSxJQUFBQSxNQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxXQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxNQUFBLEdBQUFGLE9BQUE7QUFNQSxJQUFBRyxPQUFBLEdBQUFILE9BQUE7QUFDQSxJQUFBSSxRQUFBLEdBQUFMLHNCQUFBLENBQUFDLE9BQUE7QUFBd0MsSUFBQUssU0FBQSxjQVp4QztBQUNBO0FBQUEsU0FBQUMsUUFBQUMsQ0FBQSxFQUFBQyxDQUFBLFFBQUFDLENBQUEsR0FBQUMsTUFBQSxDQUFBQyxJQUFBLENBQUFKLENBQUEsT0FBQUcsTUFBQSxDQUFBRSxxQkFBQSxRQUFBQyxDQUFBLEdBQUFILE1BQUEsQ0FBQUUscUJBQUEsQ0FBQUwsQ0FBQSxHQUFBQyxDQUFBLEtBQUFLLENBQUEsR0FBQUEsQ0FBQSxDQUFBQyxNQUFBLFdBQUFOLENBQUEsV0FBQUUsTUFBQSxDQUFBSyx3QkFBQSxDQUFBUixDQUFBLEVBQUFDLENBQUEsRUFBQVEsVUFBQSxPQUFBUCxDQUFBLENBQUFRLElBQUEsQ0FBQUMsS0FBQSxDQUFBVCxDQUFBLEVBQUFJLENBQUEsWUFBQUosQ0FBQTtBQUFBLFNBQUFVLGNBQUFa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