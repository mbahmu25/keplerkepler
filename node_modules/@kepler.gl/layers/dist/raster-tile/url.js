"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RasterLayerResources = void 0;
exports.bandIndexesToURLParams = bandIndexesToURLParams;
exports.getMeshMaxError = getMeshMaxError;
exports.getSingleCOGUrlParams = getSingleCOGUrlParams;
exports.getStacApiUrlParams = getStacApiUrlParams;
exports.getTerrainUrl = getTerrainUrl;
exports.getTitilerPathMapping = getTitilerPathMapping;
exports.getTitilerUrl = getTitilerUrl;
var _utils = require("@kepler.gl/utils");
var _config = require("./config");
// SPDX-License-Identifier: MIT
// Copyright contributors to the kepler.gl project

/* Utilities for creating request urls */
/* global URLSearchParams */

var TILE_SIZE = 256;
var STAC_SEARCH_DATA = {
  // Commenting out Microsoft for now
  // microsoft: {
  //   sentinelCollectionName: ['sentinel-2-l2a'],
  //   stacSearchUrl: 'https://planetarycomputer.microsoft.com/api/stac/v1/search'
  // },
  'earth-search': {
    sentinelCollectionName: ['sentinel-s2-l2a-cogs'],
    stacSearchUrl: 'https://earth-search.aws.element84.com/v0/search'
  }
};

/**
 * Construct query parameters to be sent to STAC API instance
 */
function constructStacApiQuery(options) {
  var _STAC_SEARCH_DATA$sta;
  var stac = options.stac,
    startDate = options.startDate,
    endDate = options.endDate,
    stacSearchProvider = options.stacSearchProvider;

  // This is a quick hack to support the same Sentinel 2 STAC object for searching both microsoft
  // and AWS
  var collections = ((_STAC_SEARCH_DATA$sta = STAC_SEARCH_DATA[stacSearchProvider]) === null || _STAC_SEARCH_DATA$sta === void 0 ? void 0 : _STAC_SEARCH_DATA$sta.sentinelCollectionName) || [stac.id];
  return {
    collections: collections,
    datetime: "".concat(startDate, "T00:00:00Z/").concat(endDate, "T23:59:59Z")
  };
}

/**
 * Perform lookup to find url of desired STAC search provider
 */
function getStacApiUrl(stacSearchProvider) {
  return STAC_SEARCH_DATA[stacSearchProvider].stacSearchUrl;
}
function getStacApiUrlParams(options) {
  var stac = options.stac,
    loadAssetIds = options.loadAssetIds,
    stacSearchProvider = options.stacSearchProvider,
    _options$mask = options.mask,
    mask = _options$mask === void 0 ? false : _options$mask;
  var query = options._stacQuery || JSON.stringify(constructStacApiQuery(options));
  var searchUrl = getStacApiUrl(stacSearchProvider);
  if (!searchUrl) {
    return null;
  }
  var bandIndexAssets = loadAssetIds.map(function (assetId) {
    var mapping = _config.DEFAULT_BAND_MAPPINGS[stac.id];
    if (!mapping) {
      // TODO provide a UI to setup custom band mapping
      return assetId;
    }
    var bandIndex = mapping[assetId];
    if (bandIndex) {
      return bandIndex;
    }

    // This is most likely incorrect as BXX is expected, not common name
    return assetId;
  });
  return new URLSearchParams({
    assets: bandIndexAssets.join(','),
    return_mask: String(mask),
    url: searchUrl,
    query: query
  });
}
function bandIndexesToURLParams(urlParams, bandIndexes) {
  if ((0, _utils.getApplicationConfig)().rasterServerUseLatestTitiler) {
    // for newer titiler versions
    bandIndexes.forEach(function (bandIndex) {
      urlParams.append('bidx', String(bandIndex + 1));
    });
  } else {
    // The parameter in titiler is `bands` for landsat/sentinel and `bidx` for COG
    // GDAL/Rasterio/rio-tiler start band indexing at one
    // older titiler versions
    urlParams.append('bidx', bandIndexes.map(function (val) {
      return val + 1;
    }).join(','));
  }
  return urlParams;
}
function getSingleCOGUrlParams(options) {
  var stac = options.stac,
    loadAssetId = options.loadAssetId,
    loadBandIndexes = options.loadBandIndexes,
    _options$mask2 = options.mask,
    mask = _options$mask2 === void 0 ? false : _options$mask2;
  var url = stac.assets[loadAssetId].href;
  if (!url) {
    return null;
  }
  var urlParams = new URLSearchParams({
    return_mask: String(mask),
    url: url
  });
  return bandIndexesToURLParams(urlParams, loadBandIndexes);
}

/**
 * Construct full URL to load tile from a Titiler-based backend
 */
function getTitilerUrl(options) {
  var _stac$rasterTileServe;
  // mask Set to false for mosaics because entire image is assumed to be valid
  var stac = options.stac,
    useSTACSearching = options.useSTACSearching,
    x = options.x,
    y = options.y,
    z = options.z;
  if (!((_stac$rasterTileServe = stac.rasterTileServerUrls) !== null && _stac$rasterTileServe !== void 0 && _stac$rasterTileServe.length)) {
    throw new Error('No raster tile servers');
  }
  var pathStem = getTitilerPathMapping(stac, useSTACSearching);
  var scale = TILE_SIZE === 512 ? '@2x' : '';
  var domain = chooseDomain(stac.rasterTileServerUrls, x, y);
  return {
    url: "".concat(domain, "/").concat(pathStem, "/tiles/WebMercatorQuad/").concat(z, "/").concat(x, "/").concat(y).concat(scale, ".npy"),
    rasterServerUrl: domain
  };
}
function getTitilerPathMapping(stac) {
  var useSTACSearching = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
  if (useSTACSearching) {
    return 'stac/mosaic';
  }
  return 'cog';
}

/**
 * Choose from available domains to load images from
 *
 * @param x  x tile index
 * @param y  y tile index
 *
 * @return domain
 */
function chooseDomain(domains, x, y) {
  var index = Math.abs(x + y) % domains.length;
  return domains[index];
}
function getTerrainUrl(rasterTileServerUrls, x, y, z, meshMaxError) {
  var scale = TILE_SIZE === 512 ? '@2x' : '';
  var params = new URLSearchParams({
    url: 'terrarium',
    mesh_max_error: meshMaxError.toFixed(2)
  });
  var domain = chooseDomain(rasterTileServerUrls, x, y);
  var baseUrl = "".concat(domain, "/mesh/tiles/").concat(z, "/").concat(x, "/").concat(y).concat(scale, ".terrain?");
  return {
    url: baseUrl + params.toString(),
    rasterServerUrl: domain
  };
}

/**
 * get mesh max error for z value
 * @param z mercator tile z coord
 * @param multiplier multipler applied to default error
 *
 * Uses suggestion from here
 * https://www.linkedin.com/pulse/fast-cesium-terrain-rendering-new-quantized-mesh-output-alvaro-huarte/
 */
function getMeshMaxError(z, multiplier) {
  return 77067.34 / (1 << z) * multiplier;
}
var RasterLayerResources = exports.RasterLayerResources = {
  rasterColorMap: function rasterColorMap(colormapId) {
    return "".concat((0, _utils.getApplicationConfig)().cdnUrl, "/raster/colormaps/").concat(colormapId, ".png");
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdXRpbHMiLCJyZXF1aXJlIiwiX2NvbmZpZyIsIlRJTEVfU0laRSIsIlNUQUNfU0VBUkNIX0RBVEEiLCJzZW50aW5lbENvbGxlY3Rpb25OYW1lIiwic3RhY1NlYXJjaFVybCIsImNvbnN0cnVjdFN0YWNBcGlRdWVyeSIsIm9wdGlvbnMiLCJfU1RBQ19TRUFSQ0hfREFUQSRzdGEiLCJzdGFjIiwic3RhcnREYXRlIiwiZW5kRGF0ZSIsInN0YWNTZWFyY2hQcm92aWRlciIsImNvbGxlY3Rpb25zIiwiaWQiLCJkYXRldGltZSIsImNvbmNhdCIsImdldFN0YWNBcGlVcmwiLCJnZXRTdGFjQXBpVXJsUGFyYW1zIiwibG9hZEFzc2V0SWRzIiwiX29wdGlvbnMkbWFzayIsIm1hc2siLCJxdWVyeSIsIl9zdGFjUXVlcnkiLCJKU09OIiwic3RyaW5naWZ5Iiwic2VhcmNoVXJsIiwiYmFuZEluZGV4QXNzZXRzIiwibWFwIiwiYXNzZXRJZCIsIm1hcHBpbmciLCJERUZBVUxUX0JBTkRfTUFQUElOR1MiLCJiYW5kSW5kZXgiLCJVUkxTZWFyY2hQYXJhbXMiLCJhc3NldHMiLCJqb2luIiwicmV0dXJuX21hc2siLCJTdHJpbmciLCJ1cmwiLCJiYW5kSW5kZXhlc1RvVVJMUGFyYW1zIiwidXJsUGFyYW1zIiwiYmFuZEluZGV4ZXMiLCJnZXRBcHBsaWNhdGlvbkNvbmZpZyIsInJhc3RlclNlcnZlclVzZUxhdGVzdFRpdGlsZXIiLCJmb3JFYWNoIiwiYXBwZW5kIiwidmFsIiwiZ2V0U2luZ2xlQ09HVXJsUGFyYW1zIiwibG9hZEFzc2V0SWQiLCJsb2FkQmFuZEluZGV4ZXMiLCJfb3B0aW9ucyRtYXNrMiIsImhyZWYiLCJnZXRUaXRpbGVyVXJsIiwiX3N0YWMkcmFzdGVyVGlsZVNlcnZlIiwidXNlU1RBQ1NlYXJjaGluZyIsIngiLCJ5IiwieiIsInJhc3RlclRpbGVTZXJ2ZXJVcmxzIiwibGVuZ3RoIiwiRXJyb3IiLCJwYXRoU3RlbSIsImdldFRpdGlsZXJQYXRoTWFwcGluZyIsInNjYWxlIiwiZG9tYWluIiwiY2hvb3NlRG9tYWluIiwicmFzdGVyU2VydmVyVXJsIiwiYXJndW1lbnRzIiwidW5kZWZpbmVkIiwiZG9tYWlucyIsImluZGV4IiwiTWF0aCIsImFicyIsImdldFRlcnJhaW5VcmwiLCJtZXNoTWF4RXJyb3IiLCJwYXJhbXMiLCJtZXNoX21heF9lcnJvciIsInRvRml4ZWQiLCJiYXNlVXJsIiwidG9TdHJpbmciLCJnZXRNZXNoTWF4RXJyb3IiLCJtdWx0aXBsaWVyIiwiUmFzdGVyTGF5ZXJSZXNvdXJjZXMiLCJleHBvcnRzIiwicmFzdGVyQ29sb3JNYXAiLCJjb2xvcm1hcElkIiwiY2RuVXJsIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL3Jhc3Rlci10aWxlL3VybC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG4vKiBVdGlsaXRpZXMgZm9yIGNyZWF0aW5nIHJlcXVlc3QgdXJscyAqL1xuLyogZ2xvYmFsIFVSTFNlYXJjaFBhcmFtcyAqL1xuXG5pbXBvcnQge1N0YWNUeXBlc30gZnJvbSAnQGtlcGxlci5nbC90eXBlcyc7XG5pbXBvcnQge2dldEFwcGxpY2F0aW9uQ29uZmlnfSBmcm9tICdAa2VwbGVyLmdsL3V0aWxzJztcblxuaW1wb3J0IHtERUZBVUxUX0JBTkRfTUFQUElOR1N9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7XG4gIEFzc2V0SWRzLFxuICBCYW5kSW5kZXhlcyxcbiAgQ29tcGxldGVTVEFDSXRlbSxcbiAgQ29tcGxldGVTVEFDQ29sbGVjdGlvbixcbiAgR2V0VGlsZURhdGFQcm9wc1xufSBmcm9tICcuL3R5cGVzJztcblxudHlwZSBJdGVtID0gU3RhY1R5cGVzLlNUQUNJdGVtO1xudHlwZSBDb2xsZWN0aW9uID0gU3RhY1R5cGVzLlNUQUNDb2xsZWN0aW9uO1xuXG5jb25zdCBUSUxFX1NJWkU6IDI1NiB8IDUxMiA9IDI1NjtcblxuaW50ZXJmYWNlIFN0YWNTZWFyY2hJbmZvIHtcbiAgc2VudGluZWxDb2xsZWN0aW9uTmFtZTogc3RyaW5nW107XG4gIHN0YWNTZWFyY2hVcmw6IHN0cmluZztcbn1cblxuY29uc3QgU1RBQ19TRUFSQ0hfREFUQTogUmVjb3JkPHN0cmluZywgU3RhY1NlYXJjaEluZm8+ID0ge1xuICAvLyBDb21tZW50aW5nIG91dCBNaWNyb3NvZnQgZm9yIG5vd1xuICAvLyBtaWNyb3NvZnQ6IHtcbiAgLy8gICBzZW50aW5lbENvbGxlY3Rpb25OYW1lOiBbJ3NlbnRpbmVsLTItbDJhJ10sXG4gIC8vICAgc3RhY1NlYXJjaFVybDogJ2h0dHBzOi8vcGxhbmV0YXJ5Y29tcHV0ZXIubWljcm9zb2Z0LmNvbS9hcGkvc3RhYy92MS9zZWFyY2gnXG4gIC8vIH0sXG4gICdlYXJ0aC1zZWFyY2gnOiB7XG4gICAgc2VudGluZWxDb2xsZWN0aW9uTmFtZTogWydzZW50aW5lbC1zMi1sMmEtY29ncyddLFxuICAgIHN0YWNTZWFyY2hVcmw6ICdodHRwczovL2VhcnRoLXNlYXJjaC5hd3MuZWxlbWVudDg0LmNvbS92MC9zZWFyY2gnXG4gIH1cbn07XG5cbi8qKlxuICogQ29uc3RydWN0IHF1ZXJ5IHBhcmFtZXRlcnMgdG8gYmUgc2VudCB0byBTVEFDIEFQSSBpbnN0YW5jZVxuICovXG5mdW5jdGlvbiBjb25zdHJ1Y3RTdGFjQXBpUXVlcnkob3B0aW9uczoge1xuICBzdGFjOiBJdGVtIHwgQ29sbGVjdGlvbjtcbiAgc3RhcnREYXRlOiBzdHJpbmc7XG4gIGVuZERhdGU6IHN0cmluZztcbiAgc3RhY1NlYXJjaFByb3ZpZGVyOiBzdHJpbmc7XG59KToge2NvbGxlY3Rpb25zOiBzdHJpbmdbXTsgZGF0ZXRpbWU6IHN0cmluZ30ge1xuICBjb25zdCB7c3RhYywgc3RhcnREYXRlLCBlbmREYXRlLCBzdGFjU2VhcmNoUHJvdmlkZXJ9ID0gb3B0aW9ucztcblxuICAvLyBUaGlzIGlzIGEgcXVpY2sgaGFjayB0byBzdXBwb3J0IHRoZSBzYW1lIFNlbnRpbmVsIDIgU1RBQyBvYmplY3QgZm9yIHNlYXJjaGluZyBib3RoIG1pY3Jvc29mdFxuICAvLyBhbmQgQVdTXG4gIGNvbnN0IGNvbGxlY3Rpb25zID0gU1RBQ19TRUFSQ0hfREFUQVtzdGFjU2VhcmNoUHJvdmlkZXJdPy5zZW50aW5lbENvbGxlY3Rpb25OYW1lIHx8IFtzdGFjLmlkXTtcblxuICByZXR1cm4ge1xuICAgIGNvbGxlY3Rpb25zLFxuICAgIGRhdGV0aW1lOiBgJHtzdGFydERhdGV9VDAwOjAwOjAwWi8ke2VuZERhdGV9VDIzOjU5OjU5WmBcbiAgfTtcbn1cblxuLyoqXG4gKiBQZXJmb3JtIGxvb2t1cCB0byBmaW5kIHVybCBvZiBkZXNpcmVkIFNUQUMgc2VhcmNoIHByb3ZpZGVyXG4gKi9cbmZ1bmN0aW9uIGdldFN0YWNBcGlVcmwoc3RhY1NlYXJjaFByb3ZpZGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gU1RBQ19TRUFSQ0hfREFUQVtzdGFjU2VhcmNoUHJvdmlkZXJdLnN0YWNTZWFyY2hVcmw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdGFjQXBpVXJsUGFyYW1zKG9wdGlvbnM6IHtcbiAgc3RhYzogQ29tcGxldGVTVEFDQ29sbGVjdGlvbjtcbiAgc3RhY1NlYXJjaFByb3ZpZGVyOiBzdHJpbmc7XG4gIHN0YXJ0RGF0ZTogc3RyaW5nO1xuICBlbmREYXRlOiBzdHJpbmc7XG4gIG1hc2s/OiBib29sZWFuO1xuICBsb2FkQXNzZXRJZHM6IEFzc2V0SWRzO1xuICBfc3RhY1F1ZXJ5Pzogc3RyaW5nO1xufSk6IFVSTFNlYXJjaFBhcmFtcyB8IG51bGwge1xuICBjb25zdCB7c3RhYywgbG9hZEFzc2V0SWRzLCBzdGFjU2VhcmNoUHJvdmlkZXIsIG1hc2sgPSBmYWxzZX0gPSBvcHRpb25zO1xuICBjb25zdCBxdWVyeSA9IG9wdGlvbnMuX3N0YWNRdWVyeSB8fCBKU09OLnN0cmluZ2lmeShjb25zdHJ1Y3RTdGFjQXBpUXVlcnkob3B0aW9ucykpO1xuICBjb25zdCBzZWFyY2hVcmwgPSBnZXRTdGFjQXBpVXJsKHN0YWNTZWFyY2hQcm92aWRlcik7XG5cbiAgaWYgKCFzZWFyY2hVcmwpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGJhbmRJbmRleEFzc2V0cyA9IGxvYWRBc3NldElkcy5tYXAoYXNzZXRJZCA9PiB7XG4gICAgY29uc3QgbWFwcGluZyA9IERFRkFVTFRfQkFORF9NQVBQSU5HU1tzdGFjLmlkXTtcbiAgICBpZiAoIW1hcHBpbmcpIHtcbiAgICAgIC8vIFRPRE8gcHJvdmlkZSBhIFVJIHRvIHNldHVwIGN1c3RvbSBiYW5kIG1hcHBpbmdcbiAgICAgIHJldHVybiBhc3NldElkO1xuICAgIH1cblxuICAgIGNvbnN0IGJhbmRJbmRleCA9IG1hcHBpbmdbYXNzZXRJZF07XG4gICAgaWYgKGJhbmRJbmRleCkge1xuICAgICAgcmV0dXJuIGJhbmRJbmRleDtcbiAgICB9XG5cbiAgICAvLyBUaGlzIGlzIG1vc3QgbGlrZWx5IGluY29ycmVjdCBhcyBCWFggaXMgZXhwZWN0ZWQsIG5vdCBjb21tb24gbmFtZVxuICAgIHJldHVybiBhc3NldElkO1xuICB9KTtcblxuICByZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh7XG4gICAgYXNzZXRzOiBiYW5kSW5kZXhBc3NldHMuam9pbignLCcpLFxuICAgIHJldHVybl9tYXNrOiBTdHJpbmcobWFzayksXG4gICAgdXJsOiBzZWFyY2hVcmwsXG4gICAgcXVlcnlcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBiYW5kSW5kZXhlc1RvVVJMUGFyYW1zKFxuICB1cmxQYXJhbXM6IFVSTFNlYXJjaFBhcmFtcyxcbiAgYmFuZEluZGV4ZXM6IEJhbmRJbmRleGVzXG4pOiBVUkxTZWFyY2hQYXJhbXMge1xuICBpZiAoZ2V0QXBwbGljYXRpb25Db25maWcoKS5yYXN0ZXJTZXJ2ZXJVc2VMYXRlc3RUaXRpbGVyKSB7XG4gICAgLy8gZm9yIG5ld2VyIHRpdGlsZXIgdmVyc2lvbnNcbiAgICBiYW5kSW5kZXhlcy5mb3JFYWNoKGJhbmRJbmRleCA9PiB7XG4gICAgICB1cmxQYXJhbXMuYXBwZW5kKCdiaWR4JywgU3RyaW5nKGJhbmRJbmRleCArIDEpKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICAvLyBUaGUgcGFyYW1ldGVyIGluIHRpdGlsZXIgaXMgYGJhbmRzYCBmb3IgbGFuZHNhdC9zZW50aW5lbCBhbmQgYGJpZHhgIGZvciBDT0dcbiAgICAvLyBHREFML1Jhc3RlcmlvL3Jpby10aWxlciBzdGFydCBiYW5kIGluZGV4aW5nIGF0IG9uZVxuICAgIC8vIG9sZGVyIHRpdGlsZXIgdmVyc2lvbnNcbiAgICB1cmxQYXJhbXMuYXBwZW5kKCdiaWR4JywgYmFuZEluZGV4ZXMubWFwKHZhbCA9PiB2YWwgKyAxKS5qb2luKCcsJykpO1xuICB9XG5cbiAgcmV0dXJuIHVybFBhcmFtcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNpbmdsZUNPR1VybFBhcmFtcyhvcHRpb25zOiB7XG4gIHN0YWM6IENvbXBsZXRlU1RBQ0l0ZW07XG4gIGxvYWRBc3NldElkOiBzdHJpbmc7XG4gIGxvYWRCYW5kSW5kZXhlczogQmFuZEluZGV4ZXM7XG4gIG1hc2s/OiBib29sZWFuO1xufSk6IFVSTFNlYXJjaFBhcmFtcyB8IG51bGwge1xuICBjb25zdCB7c3RhYywgbG9hZEFzc2V0SWQsIGxvYWRCYW5kSW5kZXhlcywgbWFzayA9IGZhbHNlfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHVybCA9IHN0YWMuYXNzZXRzW2xvYWRBc3NldElkXS5ocmVmO1xuXG4gIGlmICghdXJsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCB1cmxQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHtcbiAgICByZXR1cm5fbWFzazogU3RyaW5nKG1hc2spLFxuICAgIHVybFxuICB9KTtcbiAgcmV0dXJuIGJhbmRJbmRleGVzVG9VUkxQYXJhbXModXJsUGFyYW1zLCBsb2FkQmFuZEluZGV4ZXMpO1xufVxuXG4vKipcbiAqIENvbnN0cnVjdCBmdWxsIFVSTCB0byBsb2FkIHRpbGUgZnJvbSBhIFRpdGlsZXItYmFzZWQgYmFja2VuZFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGl0aWxlclVybChvcHRpb25zOiB7XG4gIHN0YWM6IEdldFRpbGVEYXRhUHJvcHNbJ3N0YWMnXTtcbiAgdXNlU1RBQ1NlYXJjaGluZzogYm9vbGVhbjtcbiAgeDogbnVtYmVyO1xuICB5OiBudW1iZXI7XG4gIHo6IG51bWJlcjtcbn0pOiB7dXJsOiBzdHJpbmc7IHJhc3RlclNlcnZlclVybDogc3RyaW5nfSB7XG4gIC8vIG1hc2sgU2V0IHRvIGZhbHNlIGZvciBtb3NhaWNzIGJlY2F1c2UgZW50aXJlIGltYWdlIGlzIGFzc3VtZWQgdG8gYmUgdmFsaWRcbiAgY29uc3Qge3N0YWMsIHVzZVNUQUNTZWFyY2hpbmcsIHgsIHksIHp9ID0gb3B0aW9ucztcblxuICBpZiAoIXN0YWMucmFzdGVyVGlsZVNlcnZlclVybHM/Lmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gcmFzdGVyIHRpbGUgc2VydmVycycpO1xuICB9XG5cbiAgY29uc3QgcGF0aFN0ZW0gPSBnZXRUaXRpbGVyUGF0aE1hcHBpbmcoc3RhYywgdXNlU1RBQ1NlYXJjaGluZyk7XG4gIGNvbnN0IHNjYWxlID0gVElMRV9TSVpFID09PSA1MTIgPyAnQDJ4JyA6ICcnO1xuICBjb25zdCBkb21haW4gPSBjaG9vc2VEb21haW4oc3RhYy5yYXN0ZXJUaWxlU2VydmVyVXJscywgeCwgeSk7XG4gIHJldHVybiB7XG4gICAgdXJsOiBgJHtkb21haW59LyR7cGF0aFN0ZW19L3RpbGVzL1dlYk1lcmNhdG9yUXVhZC8ke3p9LyR7eH0vJHt5fSR7c2NhbGV9Lm5weWAsXG4gICAgcmFzdGVyU2VydmVyVXJsOiBkb21haW5cbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRpdGlsZXJQYXRoTWFwcGluZyhcbiAgc3RhYzogR2V0VGlsZURhdGFQcm9wc1snc3RhYyddLFxuICB1c2VTVEFDU2VhcmNoaW5nID0gZmFsc2Vcbik6IHN0cmluZyB7XG4gIGlmICh1c2VTVEFDU2VhcmNoaW5nKSB7XG4gICAgcmV0dXJuICdzdGFjL21vc2FpYyc7XG4gIH1cblxuICByZXR1cm4gJ2NvZyc7XG59XG5cbi8qKlxuICogQ2hvb3NlIGZyb20gYXZhaWxhYmxlIGRvbWFpbnMgdG8gbG9hZCBpbWFnZXMgZnJvbVxuICpcbiAqIEBwYXJhbSB4ICB4IHRpbGUgaW5kZXhcbiAqIEBwYXJhbSB5ICB5IHRpbGUgaW5kZXhcbiAqXG4gKiBAcmV0dXJuIGRvbWFpblxuICovXG5mdW5jdGlvbiBjaG9vc2VEb21haW4oZG9tYWluczogc3RyaW5nW10sIHg6IG51bWJlciwgeTogbnVtYmVyKTogc3RyaW5nIHtcbiAgY29uc3QgaW5kZXggPSBNYXRoLmFicyh4ICsgeSkgJSBkb21haW5zLmxlbmd0aDtcbiAgcmV0dXJuIGRvbWFpbnNbaW5kZXhdO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVycmFpblVybChcbiAgcmFzdGVyVGlsZVNlcnZlclVybHM6IHN0cmluZ1tdLFxuICB4OiBudW1iZXIsXG4gIHk6IG51bWJlcixcbiAgejogbnVtYmVyLFxuICBtZXNoTWF4RXJyb3I6IG51bWJlclxuKToge3VybDogc3RyaW5nOyByYXN0ZXJTZXJ2ZXJVcmw6IHN0cmluZ30ge1xuICBjb25zdCBzY2FsZSA9IFRJTEVfU0laRSA9PT0gNTEyID8gJ0AyeCcgOiAnJztcblxuICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHtcbiAgICB1cmw6ICd0ZXJyYXJpdW0nLFxuICAgIG1lc2hfbWF4X2Vycm9yOiBtZXNoTWF4RXJyb3IudG9GaXhlZCgyKVxuICB9KTtcbiAgY29uc3QgZG9tYWluID0gY2hvb3NlRG9tYWluKHJhc3RlclRpbGVTZXJ2ZXJVcmxzLCB4LCB5KTtcbiAgY29uc3QgYmFzZVVybCA9IGAke2RvbWFpbn0vbWVzaC90aWxlcy8ke3p9LyR7eH0vJHt5fSR7c2NhbGV9LnRlcnJhaW4/YDtcbiAgcmV0dXJuIHt1cmw6IGJhc2VVcmwgKyBwYXJhbXMudG9TdHJpbmcoKSwgcmFzdGVyU2VydmVyVXJsOiBkb21haW59O1xufVxuXG4vKipcbiAqIGdldCBtZXNoIG1heCBlcnJvciBmb3IgeiB2YWx1ZVxuICogQHBhcmFtIHogbWVyY2F0b3IgdGlsZSB6IGNvb3JkXG4gKiBAcGFyYW0gbXVsdGlwbGllciBtdWx0aXBsZXIgYXBwbGllZCB0byBkZWZhdWx0IGVycm9yXG4gKlxuICogVXNlcyBzdWdnZXN0aW9uIGZyb20gaGVyZVxuICogaHR0cHM6Ly93d3cubGlua2VkaW4uY29tL3B1bHNlL2Zhc3QtY2VzaXVtLXRlcnJhaW4tcmVuZGVyaW5nLW5ldy1xdWFudGl6ZWQtbWVzaC1vdXRwdXQtYWx2YXJvLWh1YXJ0ZS9cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE1lc2hNYXhFcnJvcih6OiBudW1iZXIsIG11bHRpcGxpZXI6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiAoNzcwNjcuMzQgLyAoMSA8PCB6KSkgKiBtdWx0aXBsaWVyO1xufVxuXG5leHBvcnQgY29uc3QgUmFzdGVyTGF5ZXJSZXNvdXJjZXMgPSB7XG4gIHJhc3RlckNvbG9yTWFwOiAoY29sb3JtYXBJZDogc3RyaW5nKSA9PiB7XG4gICAgcmV0dXJuIGAke2dldEFwcGxpY2F0aW9uQ29uZmlnKCkuY2RuVXJsfS9yYXN0ZXIvY29sb3JtYXBzLyR7Y29sb3JtYXBJZH0ucG5nYDtcbiAgfVxufTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQU9BLElBQUFBLE1BQUEsR0FBQUMsT0FBQTtBQUVBLElBQUFDLE9BQUEsR0FBQUQsT0FBQTtBQVRBO0FBQ0E7O0FBRUE7QUFDQTs7QUFpQkEsSUFBTUUsU0FBb0IsR0FBRyxHQUFHO0FBT2hDLElBQU1DLGdCQUFnRCxHQUFHO0VBQ3ZEO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQSxjQUFjLEVBQUU7SUFDZEMsc0JBQXNCLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQztJQUNoREMsYUFBYSxFQUFFO0VBQ2pC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