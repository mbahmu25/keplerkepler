"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.computeDeckEffects = computeDeckEffects;
exports.fixEffectOrder = void 0;
exports.reorderEffectOrder = reorderEffectOrder;
exports.validateEffectParameters = validateEffectParameters;
var _sortable = require("@dnd-kit/sortable");
var _suncalc = _interopRequireDefault(require("suncalc"));
var _lodash = _interopRequireDefault(require("lodash.clonedeep"));
var _constants = require("@kepler.gl/constants");
var _utils = require("./utils");
var _dataUtils = require("./data-utils");
// SPDX-License-Identifier: MIT
// Copyright contributors to the kepler.gl project

// import {VisState} from '@kepler.gl/schemas';

// TODO isolate types - depends on @kepler.gl/schemas

function computeDeckEffects(_ref) {
  var visState = _ref.visState,
    mapState = _ref.mapState;
  // TODO: 1) deck effects per deck context 2) preserved between draws
  return visState.effectOrder.map(function (effectId) {
    var effect = (0, _utils.findById)(effectId)(visState.effects);
    if (effect !== null && effect !== void 0 && effect.isEnabled && effect.deckEffect) {
      updateEffect({
        visState: visState,
        mapState: mapState,
        effect: effect
      });
      return effect.deckEffect;
    }
    return null;
  }).filter(function (effect) {
    return effect;
  });
}

/**
 * Always keep light & shadow effect at the top
 */
var fixEffectOrder = exports.fixEffectOrder = function fixEffectOrder(effects, effectOrder) {
  var lightShadowEffect = effects.find(function (effect) {
    return effect.type === _constants.LIGHT_AND_SHADOW_EFFECT.type;
  });
  if (lightShadowEffect) {
    var ind = effectOrder.indexOf(lightShadowEffect.id);
    if (ind > 0) {
      effectOrder.splice(ind, 1);
      effectOrder.unshift(lightShadowEffect.id);
    }
  }
  return effectOrder;
};
function reorderEffectOrder(effectOrder, originEffectId, destinationEffectId) {
  var activeIndex = effectOrder.indexOf(originEffectId);
  var overIndex = effectOrder.indexOf(destinationEffectId);
  return (0, _sortable.arrayMove)(effectOrder, activeIndex, overIndex);
}

/**
 * Check if the current time is daytime at the given location
 * @param {number} lat Latitude
 * @param {number} lon Longitude
 * @param {number} timestamp Milliseconds since the Unix Epoch
 * @returns boolean
 */
function isDaytime(lat, lon, timestamp) {
  var date = new Date(timestamp);
  var _SunCalc$getTimes = _suncalc["default"].getTimes(date, lat, lon),
    sunrise = _SunCalc$getTimes.sunrise,
    sunset = _SunCalc$getTimes.sunset;
  return date >= sunrise && date <= sunset;
}

/**
 * Update effect to match latest vis and map states
 */
function updateEffect(_ref2) {
  var visState = _ref2.visState,
    mapState = _ref2.mapState,
    effect = _ref2.effect;
  if (effect.type === _constants.LIGHT_AND_SHADOW_EFFECT.type) {
    var timestamp = effect.parameters.timestamp;
    var timeMode = effect.parameters.timeMode;
    var sunLight = effect.deckEffect.directionalLights[0];

    // set timestamp for shadow
    if (timeMode === _constants.LIGHT_AND_SHADOW_EFFECT_TIME_MODES.current) {
      timestamp = Date.now();
      sunLight.timestamp = timestamp;
    } else if (timeMode === _constants.LIGHT_AND_SHADOW_EFFECT_TIME_MODES.animation) {
      var _visState$animationCo;
      timestamp = (_visState$animationCo = visState.animationConfig.currentTime) !== null && _visState$animationCo !== void 0 ? _visState$animationCo : 0;
      if (!timestamp) {
        var filter = visState.filters.find(function (filter) {
          return filter.type === _constants.FILTER_TYPES.timeRange && (filter.view === _constants.FILTER_VIEW_TYPES.enlarged || filter.syncedWithLayerTimeline);
        });
        if (filter) {
          var _filter$value$, _filter$value;
          timestamp = (_filter$value$ = (_filter$value = filter.value) === null || _filter$value === void 0 ? void 0 : _filter$value[0]) !== null && _filter$value$ !== void 0 ? _filter$value$ : 0;
        }
      }
      sunLight.timestamp = timestamp;
    }

    // output uniform shadow during nighttime
    if (isDaytime(mapState.latitude, mapState.longitude, timestamp)) {
      effect.deckEffect.outputUniformShadow = false;
      sunLight.intensity = effect.parameters.sunLightIntensity;
    } else {
      effect.deckEffect.outputUniformShadow = true;
      sunLight.intensity = 0;
    }
  }
}

/**
 * Validates parameters for an effect, clamps numbers to allowed ranges
 * or applies default values in case of wrong non-numeric values.
 * All unknown properties aren't modified.
 * @param parameters Parameters candidate for an effect.
 * @param effectDescription Description of an effect.
 * @returns
 */
function validateEffectParameters() {
  var parameters = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var effectDescription = arguments.length > 1 ? arguments[1] : undefined;
  var result = (0, _lodash["default"])(parameters);
  effectDescription.forEach(function (description) {
    var defaultValue = description.defaultValue,
      name = description.name,
      type = description.type,
      min = description.min,
      max = description.max;
    if (!Object.prototype.hasOwnProperty.call(result, name)) return;
    var property = result[name];
    if (type === 'color' || type === 'array') {
      if (!Array.isArray(defaultValue)) return;
      if (property.length !== (defaultValue === null || defaultValue === void 0 ? void 0 : defaultValue.length)) {
        result[name] = defaultValue;
        return;
      }
      defaultValue.forEach(function (v, i) {
        var _defaultValue$i;
        var value = property[i];
        value = Number.isFinite(value) ? (0, _dataUtils.clamp)([min, max], value) : (_defaultValue$i = defaultValue[i]) !== null && _defaultValue$i !== void 0 ? _defaultValue$i : min;
        if (value !== undefined) {
          property[i] = value;
        }
      });
      return;
    }
    var value = Number.isFinite(property) ? (0, _dataUtils.clamp)([min, max], property) : defaultValue !== null && defaultValue !== void 0 ? defaultValue : min;
    if (value !== undefined) {
      result[name] = value;
    }
  });
  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc29ydGFibGUiLCJyZXF1aXJlIiwiX3N1bmNhbGMiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2xvZGFzaCIsIl9jb25zdGFudHMiLCJfdXRpbHMiLCJfZGF0YVV0aWxzIiwiY29tcHV0ZURlY2tFZmZlY3RzIiwiX3JlZiIsInZpc1N0YXRlIiwibWFwU3RhdGUiLCJlZmZlY3RPcmRlciIsIm1hcCIsImVmZmVjdElkIiwiZWZmZWN0IiwiZmluZEJ5SWQiLCJlZmZlY3RzIiwiaXNFbmFibGVkIiwiZGVja0VmZmVjdCIsInVwZGF0ZUVmZmVjdCIsImZpbHRlciIsImZpeEVmZmVjdE9yZGVyIiwiZXhwb3J0cyIsImxpZ2h0U2hhZG93RWZmZWN0IiwiZmluZCIsInR5cGUiLCJMSUdIVF9BTkRfU0hBRE9XX0VGRkVDVCIsImluZCIsImluZGV4T2YiLCJpZCIsInNwbGljZSIsInVuc2hpZnQiLCJyZW9yZGVyRWZmZWN0T3JkZXIiLCJvcmlnaW5FZmZlY3RJZCIsImRlc3RpbmF0aW9uRWZmZWN0SWQiLCJhY3RpdmVJbmRleCIsIm92ZXJJbmRleCIsImFycmF5TW92ZSIsImlzRGF5dGltZSIsImxhdCIsImxvbiIsInRpbWVzdGFtcCIsImRhdGUiLCJEYXRlIiwiX1N1bkNhbGMkZ2V0VGltZXMiLCJTdW5DYWxjIiwiZ2V0VGltZXMiLCJzdW5yaXNlIiwic3Vuc2V0IiwiX3JlZjIiLCJwYXJhbWV0ZXJzIiwidGltZU1vZGUiLCJzdW5MaWdodCIsImRpcmVjdGlvbmFsTGlnaHRzIiwiTElHSFRfQU5EX1NIQURPV19FRkZFQ1RfVElNRV9NT0RFUyIsImN1cnJlbnQiLCJub3ciLCJhbmltYXRpb24iLCJfdmlzU3RhdGUkYW5pbWF0aW9uQ28iLCJhbmltYXRpb25Db25maWciLCJjdXJyZW50VGltZSIsImZpbHRlcnMiLCJGSUxURVJfVFlQRVMiLCJ0aW1lUmFuZ2UiLCJ2aWV3IiwiRklMVEVSX1ZJRVdfVFlQRVMiLCJlbmxhcmdlZCIsInN5bmNlZFdpdGhMYXllclRpbWVsaW5lIiwiX2ZpbHRlciR2YWx1ZSQiLCJfZmlsdGVyJHZhbHVlIiwidmFsdWUiLCJsYXRpdHVkZSIsImxvbmdpdHVkZSIsIm91dHB1dFVuaWZvcm1TaGFkb3ciLCJpbnRlbnNpdHkiLCJzdW5MaWdodEludGVuc2l0eSIsInZhbGlkYXRlRWZmZWN0UGFyYW1ldGVycyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsImVmZmVjdERlc2NyaXB0aW9uIiwicmVzdWx0IiwiY2xvbmVEZWVwIiwiZm9yRWFjaCIsImRlc2NyaXB0aW9uIiwiZGVmYXVsdFZhbHVlIiwibmFtZSIsIm1pbiIsIm1heCIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsInByb3BlcnR5IiwiQXJyYXkiLCJpc0FycmF5IiwidiIsImkiLCJfZGVmYXVsdFZhbHVlJGkiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsImNsYW1wIl0sInNvdXJjZXMiOlsiLi4vc3JjL2VmZmVjdC11dGlscy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQge2FycmF5TW92ZX0gZnJvbSAnQGRuZC1raXQvc29ydGFibGUnO1xuaW1wb3J0IFN1bkNhbGMgZnJvbSAnc3VuY2FsYyc7XG5pbXBvcnQgY2xvbmVEZWVwIGZyb20gJ2xvZGFzaC5jbG9uZWRlZXAnO1xuXG5pbXBvcnQge1Bvc3RQcm9jZXNzRWZmZWN0fSBmcm9tICdAZGVjay5nbC9jb3JlL3R5cGVkJztcblxuaW1wb3J0IHtcbiAgTElHSFRfQU5EX1NIQURPV19FRkZFQ1QsXG4gIExJR0hUX0FORF9TSEFET1dfRUZGRUNUX1RJTUVfTU9ERVMsXG4gIEZJTFRFUl9UWVBFUyxcbiAgRklMVEVSX1ZJRVdfVFlQRVNcbn0gZnJvbSAnQGtlcGxlci5nbC9jb25zdGFudHMnO1xuLy8gaW1wb3J0IHtWaXNTdGF0ZX0gZnJvbSAnQGtlcGxlci5nbC9zY2hlbWFzJztcbmltcG9ydCB7TWFwU3RhdGUsIEVmZmVjdCwgRWZmZWN0UHJvcHMsIEVmZmVjdERlc2NyaXB0aW9ufSBmcm9tICdAa2VwbGVyLmdsL3R5cGVzJztcbmltcG9ydCB7ZmluZEJ5SWR9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtjbGFtcH0gZnJvbSAnLi9kYXRhLXV0aWxzJztcblxuLy8gVE9ETyBpc29sYXRlIHR5cGVzIC0gZGVwZW5kcyBvbiBAa2VwbGVyLmdsL3NjaGVtYXNcbnR5cGUgVmlzU3RhdGUgPSBhbnk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlRGVja0VmZmVjdHMoe1xuICB2aXNTdGF0ZSxcbiAgbWFwU3RhdGVcbn06IHtcbiAgdmlzU3RhdGU6IFZpc1N0YXRlO1xuICBtYXBTdGF0ZTogTWFwU3RhdGU7XG59KTogUG9zdFByb2Nlc3NFZmZlY3RbXSB7XG4gIC8vIFRPRE86IDEpIGRlY2sgZWZmZWN0cyBwZXIgZGVjayBjb250ZXh0IDIpIHByZXNlcnZlZCBiZXR3ZWVuIGRyYXdzXG4gIHJldHVybiB2aXNTdGF0ZS5lZmZlY3RPcmRlclxuICAgIC5tYXAoZWZmZWN0SWQgPT4ge1xuICAgICAgY29uc3QgZWZmZWN0ID0gZmluZEJ5SWQoZWZmZWN0SWQpKHZpc1N0YXRlLmVmZmVjdHMpIGFzIEVmZmVjdCB8IHVuZGVmaW5lZDtcbiAgICAgIGlmIChlZmZlY3Q/LmlzRW5hYmxlZCAmJiBlZmZlY3QuZGVja0VmZmVjdCkge1xuICAgICAgICB1cGRhdGVFZmZlY3Qoe3Zpc1N0YXRlLCBtYXBTdGF0ZSwgZWZmZWN0fSk7XG4gICAgICAgIHJldHVybiBlZmZlY3QuZGVja0VmZmVjdDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0pXG4gICAgLmZpbHRlcihlZmZlY3QgPT4gZWZmZWN0KTtcbn1cblxuLyoqXG4gKiBBbHdheXMga2VlcCBsaWdodCAmIHNoYWRvdyBlZmZlY3QgYXQgdGhlIHRvcFxuICovXG5leHBvcnQgY29uc3QgZml4RWZmZWN0T3JkZXIgPSAoZWZmZWN0czogRWZmZWN0W10sIGVmZmVjdE9yZGVyOiBzdHJpbmdbXSk6IHN0cmluZ1tdID0+IHtcbiAgY29uc3QgbGlnaHRTaGFkb3dFZmZlY3QgPSBlZmZlY3RzLmZpbmQoZWZmZWN0ID0+IGVmZmVjdC50eXBlID09PSBMSUdIVF9BTkRfU0hBRE9XX0VGRkVDVC50eXBlKTtcbiAgaWYgKGxpZ2h0U2hhZG93RWZmZWN0KSB7XG4gICAgY29uc3QgaW5kID0gZWZmZWN0T3JkZXIuaW5kZXhPZihsaWdodFNoYWRvd0VmZmVjdC5pZCk7XG4gICAgaWYgKGluZCA+IDApIHtcbiAgICAgIGVmZmVjdE9yZGVyLnNwbGljZShpbmQsIDEpO1xuICAgICAgZWZmZWN0T3JkZXIudW5zaGlmdChsaWdodFNoYWRvd0VmZmVjdC5pZCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBlZmZlY3RPcmRlcjtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiByZW9yZGVyRWZmZWN0T3JkZXIoXG4gIGVmZmVjdE9yZGVyOiBzdHJpbmdbXSxcbiAgb3JpZ2luRWZmZWN0SWQ6IHN0cmluZyxcbiAgZGVzdGluYXRpb25FZmZlY3RJZDogc3RyaW5nXG4pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGFjdGl2ZUluZGV4ID0gZWZmZWN0T3JkZXIuaW5kZXhPZihvcmlnaW5FZmZlY3RJZCk7XG4gIGNvbnN0IG92ZXJJbmRleCA9IGVmZmVjdE9yZGVyLmluZGV4T2YoZGVzdGluYXRpb25FZmZlY3RJZCk7XG4gIHJldHVybiBhcnJheU1vdmUoZWZmZWN0T3JkZXIsIGFjdGl2ZUluZGV4LCBvdmVySW5kZXgpO1xufVxuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBjdXJyZW50IHRpbWUgaXMgZGF5dGltZSBhdCB0aGUgZ2l2ZW4gbG9jYXRpb25cbiAqIEBwYXJhbSB7bnVtYmVyfSBsYXQgTGF0aXR1ZGVcbiAqIEBwYXJhbSB7bnVtYmVyfSBsb24gTG9uZ2l0dWRlXG4gKiBAcGFyYW0ge251bWJlcn0gdGltZXN0YW1wIE1pbGxpc2Vjb25kcyBzaW5jZSB0aGUgVW5peCBFcG9jaFxuICogQHJldHVybnMgYm9vbGVhblxuICovXG5mdW5jdGlvbiBpc0RheXRpbWUobGF0LCBsb24sIHRpbWVzdGFtcCkge1xuICBjb25zdCBkYXRlID0gbmV3IERhdGUodGltZXN0YW1wKTtcbiAgY29uc3Qge3N1bnJpc2UsIHN1bnNldH0gPSBTdW5DYWxjLmdldFRpbWVzKGRhdGUsIGxhdCwgbG9uKTtcbiAgcmV0dXJuIGRhdGUgPj0gc3VucmlzZSAmJiBkYXRlIDw9IHN1bnNldDtcbn1cblxuLyoqXG4gKiBVcGRhdGUgZWZmZWN0IHRvIG1hdGNoIGxhdGVzdCB2aXMgYW5kIG1hcCBzdGF0ZXNcbiAqL1xuZnVuY3Rpb24gdXBkYXRlRWZmZWN0KHt2aXNTdGF0ZSwgbWFwU3RhdGUsIGVmZmVjdH0pIHtcbiAgaWYgKGVmZmVjdC50eXBlID09PSBMSUdIVF9BTkRfU0hBRE9XX0VGRkVDVC50eXBlKSB7XG4gICAgbGV0IHt0aW1lc3RhbXB9ID0gZWZmZWN0LnBhcmFtZXRlcnM7XG4gICAgY29uc3Qge3RpbWVNb2RlfSA9IGVmZmVjdC5wYXJhbWV0ZXJzO1xuICAgIGNvbnN0IHN1bkxpZ2h0ID0gZWZmZWN0LmRlY2tFZmZlY3QuZGlyZWN0aW9uYWxMaWdodHNbMF07XG5cbiAgICAvLyBzZXQgdGltZXN0YW1wIGZvciBzaGFkb3dcbiAgICBpZiAodGltZU1vZGUgPT09IExJR0hUX0FORF9TSEFET1dfRUZGRUNUX1RJTUVfTU9ERVMuY3VycmVudCkge1xuICAgICAgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcbiAgICAgIHN1bkxpZ2h0LnRpbWVzdGFtcCA9IHRpbWVzdGFtcDtcbiAgICB9IGVsc2UgaWYgKHRpbWVNb2RlID09PSBMSUdIVF9BTkRfU0hBRE9XX0VGRkVDVF9USU1FX01PREVTLmFuaW1hdGlvbikge1xuICAgICAgdGltZXN0YW1wID0gdmlzU3RhdGUuYW5pbWF0aW9uQ29uZmlnLmN1cnJlbnRUaW1lID8/IDA7XG4gICAgICBpZiAoIXRpbWVzdGFtcCkge1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSB2aXNTdGF0ZS5maWx0ZXJzLmZpbmQoXG4gICAgICAgICAgZmlsdGVyID0+XG4gICAgICAgICAgICBmaWx0ZXIudHlwZSA9PT0gRklMVEVSX1RZUEVTLnRpbWVSYW5nZSAmJlxuICAgICAgICAgICAgKGZpbHRlci52aWV3ID09PSBGSUxURVJfVklFV19UWVBFUy5lbmxhcmdlZCB8fCBmaWx0ZXIuc3luY2VkV2l0aExheWVyVGltZWxpbmUpXG4gICAgICAgICk7XG4gICAgICAgIGlmIChmaWx0ZXIpIHtcbiAgICAgICAgICB0aW1lc3RhbXAgPSBmaWx0ZXIudmFsdWU/LlswXSA/PyAwO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBzdW5MaWdodC50aW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgfVxuXG4gICAgLy8gb3V0cHV0IHVuaWZvcm0gc2hhZG93IGR1cmluZyBuaWdodHRpbWVcbiAgICBpZiAoaXNEYXl0aW1lKG1hcFN0YXRlLmxhdGl0dWRlLCBtYXBTdGF0ZS5sb25naXR1ZGUsIHRpbWVzdGFtcCkpIHtcbiAgICAgIGVmZmVjdC5kZWNrRWZmZWN0Lm91dHB1dFVuaWZvcm1TaGFkb3cgPSBmYWxzZTtcbiAgICAgIHN1bkxpZ2h0LmludGVuc2l0eSA9IGVmZmVjdC5wYXJhbWV0ZXJzLnN1bkxpZ2h0SW50ZW5zaXR5O1xuICAgIH0gZWxzZSB7XG4gICAgICBlZmZlY3QuZGVja0VmZmVjdC5vdXRwdXRVbmlmb3JtU2hhZG93ID0gdHJ1ZTtcbiAgICAgIHN1bkxpZ2h0LmludGVuc2l0eSA9IDA7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogVmFsaWRhdGVzIHBhcmFtZXRlcnMgZm9yIGFuIGVmZmVjdCwgY2xhbXBzIG51bWJlcnMgdG8gYWxsb3dlZCByYW5nZXNcbiAqIG9yIGFwcGxpZXMgZGVmYXVsdCB2YWx1ZXMgaW4gY2FzZSBvZiB3cm9uZyBub24tbnVtZXJpYyB2YWx1ZXMuXG4gKiBBbGwgdW5rbm93biBwcm9wZXJ0aWVzIGFyZW4ndCBtb2RpZmllZC5cbiAqIEBwYXJhbSBwYXJhbWV0ZXJzIFBhcmFtZXRlcnMgY2FuZGlkYXRlIGZvciBhbiBlZmZlY3QuXG4gKiBAcGFyYW0gZWZmZWN0RGVzY3JpcHRpb24gRGVzY3JpcHRpb24gb2YgYW4gZWZmZWN0LlxuICogQHJldHVybnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlRWZmZWN0UGFyYW1ldGVycyhcbiAgcGFyYW1ldGVyczogRWZmZWN0UHJvcHNbJ3BhcmFtZXRlcnMnXSA9IHt9LFxuICBlZmZlY3REZXNjcmlwdGlvbjogRWZmZWN0RGVzY3JpcHRpb25bJ3BhcmFtZXRlcnMnXVxuKTogRWZmZWN0UHJvcHNbJ3BhcmFtZXRlcnMnXSB7XG4gIGNvbnN0IHJlc3VsdCA9IGNsb25lRGVlcChwYXJhbWV0ZXJzKTtcbiAgZWZmZWN0RGVzY3JpcHRpb24uZm9yRWFjaChkZXNjcmlwdGlvbiA9PiB7XG4gICAgY29uc3Qge2RlZmF1bHRWYWx1ZSwgbmFtZSwgdHlwZSwgbWluLCBtYXh9ID0gZGVzY3JpcHRpb247XG5cbiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIG5hbWUpKSByZXR1cm47XG4gICAgY29uc3QgcHJvcGVydHkgPSByZXN1bHRbbmFtZV07XG5cbiAgICBpZiAodHlwZSA9PT0gJ2NvbG9yJyB8fCB0eXBlID09PSAnYXJyYXknKSB7XG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGVmYXVsdFZhbHVlKSkgcmV0dXJuO1xuICAgICAgaWYgKHByb3BlcnR5Lmxlbmd0aCAhPT0gZGVmYXVsdFZhbHVlPy5sZW5ndGgpIHtcbiAgICAgICAgcmVzdWx0W25hbWVdID0gZGVmYXVsdFZhbHVlO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkZWZhdWx0VmFsdWUuZm9yRWFjaCgodiwgaSkgPT4ge1xuICAgICAgICBsZXQgdmFsdWUgPSBwcm9wZXJ0eVtpXTtcbiAgICAgICAgdmFsdWUgPSBOdW1iZXIuaXNGaW5pdGUodmFsdWUpID8gY2xhbXAoW21pbiwgbWF4XSwgdmFsdWUpIDogZGVmYXVsdFZhbHVlW2ldID8/IG1pbjtcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBwcm9wZXJ0eVtpXSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZSA9IE51bWJlci5pc0Zpbml0ZShwcm9wZXJ0eSkgPyBjbGFtcChbbWluLCBtYXhdLCBwcm9wZXJ0eSkgOiBkZWZhdWx0VmFsdWUgPz8gbWluO1xuXG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlc3VsdFtuYW1lXSA9IHZhbHVlO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiByZXN1bHQ7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFHQSxJQUFBQSxTQUFBLEdBQUFDLE9BQUE7QUFDQSxJQUFBQyxRQUFBLEdBQUFDLHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBRyxPQUFBLEdBQUFELHNCQUFBLENBQUFGLE9BQUE7QUFJQSxJQUFBSSxVQUFBLEdBQUFKLE9BQUE7QUFRQSxJQUFBSyxNQUFBLEdBQUFMLE9BQUE7QUFDQSxJQUFBTSxVQUFBLEdBQUFOLE9BQUE7QUFsQkE7QUFDQTs7QUFjQTs7QUFLQTs7QUFHTyxTQUFTTyxrQkFBa0JBLENBQUFDLElBQUEsRUFNVjtFQUFBLElBTHRCQyxRQUFRLEdBQUFELElBQUEsQ0FBUkMsUUFBUTtJQUNSQyxRQUFRLEdBQUFGLElBQUEsQ0FBUkUsUUFBUTtFQUtSO0VBQ0EsT0FBT0QsUUFBUSxDQUFDRSxXQUFXLENBQ3hCQyxHQUFHLENBQUMsVUFBQUMsUUFBUSxFQUFJO0lBQ2YsSUFBTUMsTUFBTSxHQUFHLElBQUFDLGVBQVEsRUFBQ0YsUUFBUSxDQUFDLENBQUNKLFFBQVEsQ0FBQ08sT0FBTyxDQUF1QjtJQUN6RSxJQUFJRixNQUFNLGFBQU5BLE1BQU0sZUFBTkEsTUFBTSxDQUFFRyxTQUFTLElBQUlILE1BQU0sQ0FBQ0ksVUFBVSxFQUFFO01BQzFDQyxZQUFZLENBQUM7UUFBQ1YsUUFBUSxFQUFSQSxRQUFRO1FBQUVDLFFBQVEsRUFBUkEsUUFBUTtRQUFFSSxNQUFNLEVBQU5BO01BQU0sQ0FBQyxDQUFDO01BQzFDLE9BQU9BLE1BQU0sQ0FBQ0ksVUFBVTtJQUMxQjtJQUNBLE9BQU8sSUFBSTtFQUNiLENBQUMsQ0FBQyxDQUNERSxNQUFNLENBQUMsVUFBQU4sTUFBTTtJQUFBLE9BQUlBLE1BQU07RUFBQSxFQUFDO0FBQzdCOztBQUVBO0FBQ0E7QUFDQTtBQUNPLElBQU1PLGNBQWMsR0FBQUMsT0FBQSxDQUFBRCxjQUFBLEdBQUcsU0FBakJBLGNBQWNBLENBQUlMLE9BQWlCLEVBQUVMLFdBQXFCLEVBQWU7RUFDcEYsSUFBTVksaUJBQWlCLEdBQUdQLE9BQU8sQ0FBQ1EsSUFBSSxDQUFDLFVBQUFWLE1BQU07SUFBQSxPQUFJQSxNQUFNLENBQUNXLElBQUksS0FBS0Msa0NBQXVCLENBQUNELElBQUk7RUFBQSxFQUFDO0VBQzlGLElBQUlGLGlCQUFpQixFQUFFO0lBQ3JCLElBQU1JLEdBQUcsR0FBR2hCLFdBQVcsQ0FBQ2lCLE9BQU8sQ0FBQ0wsaUJBQWlCLENBQUNNLEVBQUUsQ0FBQztJQUNyRCxJQUFJRixHQUFHLEdBQUcsQ0FBQyxFQUFFO01BQ1hoQixXQUFXLENBQUNtQixNQUFNLENBQUNILEdBQUcsRUFBRSxDQUFDLENBQUM7TUFDMUJoQixXQUFXLENBQUNvQixPQUFPLENBQUNSLGlCQUFpQixDQUFDTSxFQUFFLENBQUM7SUFDM0M7RUFDRjtFQUNBLE9BQU9sQixXQUFXO0FBQ3BCLENBQUM7QUFFTSxTQUFTcUIsa0JBQWtCQSxDQUNoQ3JCLFdBQXFCLEVBQ3JCc0IsY0FBc0IsRUFDdEJDLG1CQUEyQixFQUNqQjtFQUNWLElBQU1DLFdBQVcsR0FBR3hCLFdBQVcsQ0FBQ2lCLE9BQU8sQ0FBQ0ssY0FBYyxDQUFDO0VBQ3ZELElBQU1HLFNBQVMsR0FBR3pCLFdBQVcsQ0FBQ2lCLE9BQU8sQ0FBQ00sbUJBQW1CLENBQUM7RUFDMUQsT0FBTyxJQUFBRyxtQkFBUyxFQUFDMUIsV0FBVyxFQUFFd0IsV0FBVyxFQUFFQyxTQUFTLENBQUM7QUFDdkQ7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTRSxTQUFTQSxDQUFDQyxHQUFHLEVBQUVDLEdBQUcsRUFBRUMsU0FBUyxFQUFFO0VBQ3RDLElBQU1DLElBQUksR0FBRyxJQUFJQyxJQUFJLENBQUNGLFNBQVMsQ0FBQztFQUNoQyxJQUFBRyxpQkFBQSxHQUEwQkMsbUJBQU8sQ0FBQ0MsUUFBUSxDQUFDSixJQUFJLEVBQUVILEdBQUcsRUFBRUMsR0FBRyxDQUFDO0lBQW5ETyxPQUFPLEdBQUFILGlCQUFBLENBQVBHLE9BQU87SUFBRUMsTUFBTSxHQUFBSixpQkFBQSxDQUFOSSxNQUFNO0VBQ3RCLE9BQU9OLElBQUksSUFBSUssT0FBTyxJQUFJTCxJQUFJLElBQUlNLE1BQU07QUFDMUM7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsU0FBUzdCLFlBQVlBLENBQUE4QixLQUFBLEVBQStCO0VBQUEsSUFBN0J4QyxRQUFRLEdBQUF3QyxLQUFBLENBQVJ4QyxRQUFRO0lBQUVDLFFBQVEsR0FBQXVDLEtBQUEsQ0FBUnZDLFFBQVE7SUFBRUksTUFBTSxHQUFBbUMsS0FBQSxDQUFObkMsTUFBTTtFQUMvQyxJQUFJQSxNQUFNLENBQUNXLElBQUksS0FBS0Msa0NBQXVCLENBQUNELElBQUksRUFBRTtJQUNoRCxJQUFLZ0IsU0FBUyxHQUFJM0IsTUFBTSxDQUFDb0MsVUFBVSxDQUE5QlQsU0FBUztJQUNkLElBQU9VLFFBQVEsR0FBSXJDLE1BQU0sQ0FBQ29DLFVBQVUsQ0FBN0JDLFFBQVE7SUFDZixJQUFNQyxRQUFRLEdBQUd0QyxNQUFNLENBQUNJLFVBQVUsQ0FBQ21DLGlCQUFpQixDQUFDLENBQUMsQ0FBQzs7SUFFdkQ7SUFDQSxJQUFJRixRQUFRLEtBQUtHLDZDQUFrQyxDQUFDQyxPQUFPLEVBQUU7TUFDM0RkLFNBQVMsR0FBR0UsSUFBSSxDQUFDYSxHQUFHLENBQUMsQ0FBQztNQUN0QkosUUFBUSxDQUFDWCxTQUFTLEdBQUdBLFNBQVM7SUFDaEMsQ0FBQyxNQUFNLElBQUlVLFFBQVEsS0FBS0csNkNBQWtDLENBQUNHLFNBQVMsRUFBRTtNQUFBLElBQUFDLHFCQUFBO01BQ3BFakIsU0FBUyxJQUFBaUIscUJBQUEsR0FBR2pELFFBQVEsQ0FBQ2tELGVBQWUsQ0FBQ0MsV0FBVyxjQUFBRixxQkFBQSxjQUFBQSxxQkFBQSxHQUFJLENBQUM7TUFDckQsSUFBSSxDQUFDakIsU0FBUyxFQUFFO1FBQ2QsSUFBTXJCLE1BQU0sR0FBR1gsUUFBUSxDQUFDb0QsT0FBTyxDQUFDckMsSUFBSSxDQUNsQyxVQUFBSixNQUFNO1VBQUEsT0FDSkEsTUFBTSxDQUFDSyxJQUFJLEtBQUtxQyx1QkFBWSxDQUFDQyxTQUFTLEtBQ3JDM0MsTUFBTSxDQUFDNEMsSUFBSSxLQUFLQyw0QkFBaUIsQ0FBQ0MsUUFBUSxJQUFJOUMsTUFBTSxDQUFDK0MsdUJBQXVCLENBQUM7UUFBQSxDQUNsRixDQUFDO1FBQ0QsSUFBSS9DLE1BQU0sRUFBRTtVQUFBLElBQUFnRCxjQUFBLEVBQUFDLGFBQUE7VUFDVjVCLFNBQVMsSUFBQTJCLGNBQUEsSUFBQUMsYUFBQSxHQUFHakQsTUFBTSxDQUFDa0QsS0FBSyxjQUFBRCxhQUFBLHVCQUFaQSxhQUFBLENBQWUsQ0FBQyxDQUFDLGNBQUFELGNBQUEsY0FBQUEsY0FBQSxHQUFJLENBQUM7UUFDcEM7TUFDRjtNQUNBaEIsUUFBUSxDQUFDWCxTQUFTLEdBQUdBLFNBQVM7SUFDaEM7O0lBRUE7SUFDQSxJQUFJSCxTQUFTLENBQUM1QixRQUFRLENBQUM2RCxRQUFRLEVBQUU3RCxRQUFRLENBQUM4RCxTQUFTLEVBQUUvQixTQUFTLENBQUMsRUFBRTtNQUMvRDNCLE1BQU0sQ0FBQ0ksVUFBVSxDQUFDdUQsbUJBQW1CLEdBQUcsS0FBSztNQUM3Q3JCLFFBQVEsQ0FBQ3NCLFNBQVMsR0FBRzVELE1BQU0sQ0FBQ29DLFVBQVUsQ0FBQ3lCLGlCQUFpQjtJQUMxRCxDQUFDLE1BQU07TUFDTDdELE1BQU0sQ0FBQ0ksVUFBVSxDQUFDdUQsbUJBQW1CLEdBQUcsSUFBSTtNQUM1Q3JCLFFBQVEsQ0FBQ3NCLFNBQVMsR0FBRyxDQUFDO0lBQ3hCO0VBQ0Y7QUFDRjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ08sU0FBU0Usd0JBQXdCQSxDQUFBLEVBR1g7RUFBQSxJQUYzQjFCLFVBQXFDLEdBQUEyQixTQUFBLENBQUFDLE1BQUEsUUFBQUQsU0FBQSxRQUFBRSxTQUFBLEdBQUFGLFNBQUEsTUFBRyxDQUFDLENBQUM7RUFBQSxJQUMxQ0csaUJBQWtELEdBQUFILFNBQUEsQ0FBQUMsTUFBQSxPQUFBRCxTQUFBLE1BQUFFLFNBQUE7RUFFbEQsSUFBTUUsTUFBTSxHQUFHLElBQUFDLGtCQUFTLEVBQUNoQyxVQUFVLENBQUM7RUFDcEM4QixpQkFBaUIsQ0FBQ0csT0FBTyxDQUFDLFVBQUFDLFdBQVcsRUFBSTtJQUN2QyxJQUFPQyxZQUFZLEdBQTBCRCxXQUFXLENBQWpEQyxZQUFZO01BQUVDLElBQUksR0FBb0JGLFdBQVcsQ0FBbkNFLElBQUk7TUFBRTdELElBQUksR0FBYzJELFdBQVcsQ0FBN0IzRCxJQUFJO01BQUU4RCxHQUFHLEdBQVNILFdBQVcsQ0FBdkJHLEdBQUc7TUFBRUMsR0FBRyxHQUFJSixXQUFXLENBQWxCSSxHQUFHO0lBRXpDLElBQUksQ0FBQ0MsTUFBTSxDQUFDQyxTQUFTLENBQUNDLGNBQWMsQ0FBQ0MsSUFBSSxDQUFDWCxNQUFNLEVBQUVLLElBQUksQ0FBQyxFQUFFO0lBQ3pELElBQU1PLFFBQVEsR0FBR1osTUFBTSxDQUFDSyxJQUFJLENBQUM7SUFFN0IsSUFBSTdELElBQUksS0FBSyxPQUFPLElBQUlBLElBQUksS0FBSyxPQUFPLEVBQUU7TUFDeEMsSUFBSSxDQUFDcUUsS0FBSyxDQUFDQyxPQUFPLENBQUNWLFlBQVksQ0FBQyxFQUFFO01BQ2xDLElBQUlRLFFBQVEsQ0FBQ2YsTUFBTSxNQUFLTyxZQUFZLGFBQVpBLFlBQVksdUJBQVpBLFlBQVksQ0FBRVAsTUFBTSxHQUFFO1FBQzVDRyxNQUFNLENBQUNLLElBQUksQ0FBQyxHQUFHRCxZQUFZO1FBQzNCO01BQ0Y7TUFDQUEsWUFBWSxDQUFDRixPQUFPLENBQUMsVUFBQ2EsQ0FBQyxFQUFFQyxDQUFDLEVBQUs7UUFBQSxJQUFBQyxlQUFBO1FBQzdCLElBQUk1QixLQUFLLEdBQUd1QixRQUFRLENBQUNJLENBQUMsQ0FBQztRQUN2QjNCLEtBQUssR0FBRzZCLE1BQU0sQ0FBQ0MsUUFBUSxDQUFDOUIsS0FBSyxDQUFDLEdBQUcsSUFBQStCLGdCQUFLLEVBQUMsQ0FBQ2QsR0FBRyxFQUFFQyxHQUFHLENBQUMsRUFBRWxCLEtBQUssQ0FBQyxJQUFBNEIsZUFBQSxHQUFHYixZQUFZLENBQUNZLENBQUMsQ0FBQyxjQUFBQyxlQUFBLGNBQUFBLGVBQUEsR0FBSVgsR0FBRztRQUNsRixJQUFJakIsS0FBSyxLQUFLUyxTQUFTLEVBQUU7VUFDdkJjLFFBQVEsQ0FBQ0ksQ0FBQyxDQUFDLEdBQUczQixLQUFLO1FBQ3JCO01BQ0YsQ0FBQyxDQUFDO01BQ0Y7SUFDRjtJQUVBLElBQU1BLEtBQUssR0FBRzZCLE1BQU0sQ0FBQ0MsUUFBUSxDQUFDUCxRQUFRLENBQUMsR0FBRyxJQUFBUSxnQkFBSyxFQUFDLENBQUNkLEdBQUcsRUFBRUMsR0FBRyxDQUFDLEVBQUVLLFFBQVEsQ0FBQyxHQUFHUixZQUFZLGFBQVpBLFlBQVksY0FBWkEsWUFBWSxHQUFJRSxHQUFHO0lBRTNGLElBQUlqQixLQUFLLEtBQUtTLFNBQVMsRUFBRTtNQUN2QkUsTUFBTSxDQUFDSyxJQUFJLENBQUMsR0FBR2hCLEtBQUs7SUFDdEI7RUFDRixDQUFDLENBQUM7RUFDRixPQUFPVyxNQUFNO0FBQ2YiLCJpZ25vcmVMaXN0IjpbXX0=